<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Properties & Enterprises Bureau</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom CSS for elements Tailwind can't handle easily */
        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }
        .image-preview {
            height: 150px;
            background-size: cover;
            background-position: center;
            border-radius: 0.5rem;
            position: relative;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        .modal-content {
            background-color: #1a1a1a;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #333;
            width: 80%;
            max-width: 800px;
            border-radius: 0.5rem;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: white;
        }
        .slide {
            display: none;
            text-align: center;
        }
        .slide.active {
            display: block;
        }
        .carousel-image {
            max-height: 400px;
            max-width: 100%;
            margin: 0 auto;
        }
        .carousel-nav {
            text-align: center;
            margin-top: 1rem;
        }
        .carousel-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #555;
            border-radius: 50%;
            margin: 0 5px;
            cursor: pointer;
        }
        .carousel-dot.active {
            background-color: #fff;
        }
        /* Dark theme scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 shadow-lg sticky top-0 z-10">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-building text-blue-400 text-2xl"></i>
                <h1 class="text-xl font-bold">Properties & Enterprises Bureau</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="searchBtn" class="p-2 rounded-full hover:bg-gray-700">
                    <i class="fas fa-search"></i>
                </button>
                <button id="adminLoginBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium">
                    Admin Login
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Search and Filter Section (Hidden by default) -->
        <div id="searchSection" class="bg-gray-800 p-4 rounded-lg mb-6 hidden">
            <div class="flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0">
                <div class="flex-1">
                    <label for="searchInput" class="block mb-2 font-medium">Search</label>
                    <input type="text" id="searchInput" placeholder="Business name or owner..." 
                           class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="statusFilter" class="block mb-2 font-medium">Status</label>
                    <select id="statusFilter" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Statuses</option>
                        <option value="valid">Valid</option>
                        <option value="near-expiry">Near Expiry</option>
                        <option value="expired">Expired</option>
                    </select>
                </div>
                <div>
                    <label for="typeFilter" class="block mb-2 font-medium">Type</label>
                    <select id="typeFilter" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Types</option>
                        <option value="restaurant">Restaurant</option>
                        <option value="store">Store</option>
                        <option value="mechanic">Mechanic</option>
                        <option value="clothing">Clothing</option>
                        <option value="bank">Bank</option>
                        <option value="club">Club/Entertainment</option>
                        <option value="security">Security</option>
                        <option value="tech">Tech/Repair</option>
                        <option value="health">Health/Clinic</option>
                        <option value="transportation">Transportation</option>
                        <option value="government">Government Office</option>
                        <option value="real-estate">Real Estate</option>
                        <option value="law">Law Office</option>
                        <option value="media">Media/News</option>
                        <option value="warehouse">Warehouse</option>
                        <option value="freelance">Freelance/Custom</option>
                    </select>
                </div>
                <div>
                    <label for="locationFilter" class="block mb-2 font-medium">Location</label>
                    <select id="locationFilter" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Locations</option>
                        <option value="city1">City 1</option>
                        <option value="city2">City 2</option>
                        <option value="mountain">Mountain</option>
                        <option value="desert">Desert</option>
                        <option value="province">Province</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="applyFiltersBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-medium h-10">
                        Apply
                    </button>
                </div>
            </div>
        </div>

        <!-- Business List Section -->
        <section>
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Registered Businesses</h2>
                <div class="flex space-x-2">
                    <span id="totalBusinesses" class="bg-gray-700 px-3 py-1 rounded-lg">Total: 0</span>
                    <span id="validCount" class="bg-green-600 px-3 py-1 rounded-lg">Valid: 0</span>
                    <span id="expiringCount" class="bg-yellow-600 px-3 py-1 rounded-lg">Expiring: 0</span>
                    <span id="expiredCount" class="bg-red-600 px-3 py-1 rounded-lg">Expired: 0</span>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full bg-gray-800 rounded-lg overflow-hidden">
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="px-4 py-3 text-left">Business Name</th>
                            <th class="px-4 py-3 text-left">Owner</th>
                            <th class="px-4 py-3 text-left">Type</th>
                            <th class="px-4 py-3 text-left">Location</th>
                            <th class="px-4 py-3 text-left">Status</th>
                            <th class="px-4 py-3 text-left">Last Renewal</th>
                            <th class="px-4 py-3 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="businessTableBody">
                        <!-- Business rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="flex justify-between items-center mt-4">
                <div>
                    <span id="pageInfo" class="text-gray-400">Page 1 of 1</span>
                </div>
                <div class="flex space-x-2">
                    <button id="prevPageBtn" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg disabled:opacity-50" disabled>
                        Previous
                    </button>
                    <button id="nextPageBtn" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg disabled:opacity-50" disabled>
                        Next
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Admin Login</h2>
            <div class="mb-4">
                <label for="adminKey" class="block mb-2 font-medium">Enter Admin Key</label>
                <input type="password" id="adminKey" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex justify-end space-x-2">
                <button id="cancelLoginBtn" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded-lg font-medium">
                    Cancel
                </button>
                <button id="submitLoginBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-medium">
                    Submit
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Business Modal -->
    <div id="businessModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="businessModalTitle" class="text-2xl font-bold mb-4">Add New Business</h2>
            
            <form id="businessForm" class="space-y-4">
                <input type="hidden" id="businessId">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="businessName" class="block mb-2 font-medium">Business Name*</label>
                        <input type="text" id="businessName" required 
                               class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label for="businessOwner" class="block mb-2 font-medium">Owner Name*</label>
                        <input type="text" id="businessOwner" required 
                               class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label for="businessType" class="block mb-2 font-medium">Business Type*</label>
                        <select id="businessType" required 
                                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Type</option>
                            <option value="restaurant">Restaurant</option>
                            <option value="store">Store</option>
                            <option value="mechanic">Mechanic</option>
                            <option value="clothing">Clothing</option>
                            <option value="bank">Bank</option>
                            <option value="club">Club/Entertainment</option>
                            <option value="security">Security</option>
                            <option value="tech">Tech/Repair</option>
                            <option value="health">Health/Clinic</option>
                            <option value="transportation">Transportation</option>
                            <option value="government">Government Office</option>
                            <option value="real-estate">Real Estate</option>
                            <option value="law">Law Office</option>
                            <option value="media">Media/News</option>
                            <option value="warehouse">Warehouse</option>
                            <option value="freelance">Freelance/Custom</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="businessLocation" class="block mb-2 font-medium">Location*</label>
                        <select id="businessLocation" required 
                                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Location</option>
                            <option value="city1">City 1</option>
                            <option value="city2">City 2</option>
                            <option value="mountain">Mountain</option>
                            <option value="desert">Desert</option>
                            <option value="province">Province</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="applicationDate" class="block mb-2 font-medium">Date of Application*</label>
                        <input type="date" id="applicationDate" required 
                               class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label for="renewalDate" class="block mb-2 font-medium">Last Renewal Date*</label>
                        <input type="date" id="renewalDate" required 
                               class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div>
                    <label class="block mb-2 font-medium">Business Images</label>
                    <div class="image-preview-container mb-2" id="imagePreviewContainer">
                        <!-- Image previews will be added here -->
                    </div>
                    <div class="flex space-x-2">
                        <label for="frontView" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg cursor-pointer">
                            <i class="fas fa-camera mr-2"></i>Front View
                            <input type="file" id="frontView" accept="image/*" class="hidden">
                        </label>
                        <label for="overview" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg cursor-pointer">
                            <i class="fas fa-image mr-2"></i>Overview
                            <input type="file" id="overview" accept="image/*" class="hidden">
                        </label>
                        <label for="map" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg cursor-pointer">
                            <i class="fas fa-map mr-2"></i>Map
                            <input type="file" id="map" accept="image/*" class="hidden">
                        </label>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" id="cancelBusinessBtn" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded-lg font-medium">
                        Cancel
                    </button>
                    <button type="submit" id="submitBusinessBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-medium">
                        Submit
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Business Modal -->
    <div id="viewBusinessModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="viewBusinessName" class="text-2xl font-bold mb-4"></h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div class="bg-gray-800 p-4 rounded-lg mb-4">
                        <h3 class="text-lg font-semibold mb-2 border-b border-gray-700 pb-2">Business Details</h3>
                        <div class="space-y-2">
                            <p><span class="font-medium">Owner:</span> <span id="viewOwner"></span></p>
                            <p><span class="font-medium">Type:</span> <span id="viewType"></span></p>
                            <p><span class="font-medium">Location:</span> <span id="viewLocation"></span></p>
                            <p><span class="font-medium">Application Date:</span> <span id="viewAppDate"></span></p>
                            <p><span class="font-medium">Last Renewal:</span> <span id="viewRenewalDate"></span></p>
                            <p><span class="font-medium">Status:</span> <span id="viewStatus"></span></p>
                        </div>
                    </div>
                    
                    <div id="adminActions" class="hidden">
                        <h3 class="text-lg font-semibold mb-2 border-b border-gray-700 pb-2">Admin Actions</h3>
                        <div class="flex flex-wrap gap-2">
                            <button id="editBusinessBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium">
                                <i class="fas fa-edit mr-2"></i>Edit
                            </button>
                            <button id="renewBusinessBtn" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded-lg font-medium">
                                <i class="fas fa-sync-alt mr-2"></i>Renew
                            </button>
                            <button id="deleteBusinessBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-medium">
                                <i class="fas fa-trash-alt mr-2"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-2 border-b border-gray-700 pb-2">Business Images</h3>
                    <div id="businessCarousel" class="relative">
                        <!-- Carousel slides will be added here -->
                    </div>
                    <div id="carouselNav" class="carousel-nav mt-4">
                        <!-- Navigation dots will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal (Key 1 only) -->
    <div id="adminPanelModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Admin Panel</h2>
            
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2 border-b border-gray-700 pb-2">Admin Keys Management</h3>
                <div class="space-y-4">
                    <div class="flex items-center space-x-2">
                        <input type="text" id="newKeyInput" placeholder="Enter new key" 
                               class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="newKeyType" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="1">Key 1 (Owner)</option>
                            <option value="2">Key 2 (Employee)</option>
                        </select>
                        <button id="addKeyBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-medium">
                            Add Key
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full bg-gray-800 rounded-lg overflow-hidden">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-4 py-3 text-left">Key</th>
                                    <th class="px-4 py-3 text-left">Type</th>
                                    <th class="px-4 py-3 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminKeysTableBody">
                                <!-- Admin keys will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div>
                <h3 class="text-lg font-semibold mb-2 border-b border-gray-700 pb-2">Activity Logs</h3>
                <div class="bg-gray-800 p-4 rounded-lg max-h-60 overflow-y-auto">
                    <ul id="activityLogs" class="space-y-2">
                        <!-- Activity logs will be inserted here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content max-w-md">
            <span class="close">&times;</span>
            <h2 id="confirmTitle" class="text-xl font-bold mb-4"></h2>
            <p id="confirmMessage" class="mb-6"></p>
            <div class="flex justify-end space-x-2">
                <button id="cancelConfirmBtn" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded-lg font-medium">
                    Cancel
                </button>
                <button id="confirmActionBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-medium">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 py-4 mt-8">
        <div class="container mx-auto px-4 text-center text-gray-400">
            <p>Properties & Enterprises Bureau System - Roleplay Environment</p>
            <p class="text-sm mt-1">Â© 2023 All Rights Reserved</p>
        </div>
    </footer>

    <script>
        // Sample data for businesses
        let businesses = [
            {
                id: 1,
                name: "Sunset Diner",
                owner: "John Smith",
                type: "restaurant",
                location: "city1",
                applicationDate: "06/15/2023",
                renewalDate: "07/15/2023",
                status: "valid",
                images: [
                    {type: "front", url: "https://images.unsplash.com/photo-1555396273-367ea4eb4db5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=774&q=80"},
                    {type: "overview", url: "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=870&q=80"},
                    {type: "map", url: "https://images.unsplash.com/photo-1571494146906-86de15d3817b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=870&q=80"}
                ]
            },
            {
                id: 2,
                name: "Tech Solutions",
                owner: "Sarah Johnson",
                type: "tech",
                location: "city2",
                applicationDate: "05/20/2023",
                renewalDate: "06/20/2023",
                status: "expired",
                images: [
                    {type: "front", url: "https://images.unsplash.com/photo-1550751827-4bd374c3f58b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=870&q=80"},
                    {type: "overview", url: "https://images.unsplash.com/photo-1497366754035-f200968a6e72?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=870&q=80"}
                ]
            },
            {
                id: 3,
                name: "Mountain View Lodge",
                owner: "Robert Wilson",
                type: "club",
                location: "mountain",
                applicationDate: "07/01/2023",
                renewalDate: "08/01/2023",
                status: "near-expiry",
                images: [
                    {type: "front", url: "https://images.unsplash.com/photo-1566073771259-6a8506099945?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=870&q=80"},
                    {type: "map", url: "https://images.unsplash.com/photo-1549144511-f099e773c147?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=774&q=80"}
                ]
            },
            {
                id: 4,
                name: "Desert Oasis",
                owner: "Maria Garcia",
                type: "restaurant",
                location: "desert",
                applicationDate: "06/10/2023",
                renewalDate: "07/10/2023",
                status: "valid",
                images: [
                    {type: "front", url: "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=870&q=80"},
                    {type: "overview", url: "https://images.unsplash.com/photo-1555396273-367ea4eb4db5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=774&q=80"}
                ]
            },
            {
                id: 5,
                name: "Provincial Bank",
                owner: "James Brown",
                type: "bank",
                location: "province",
                applicationDate: "05/15/2023",
                renewalDate: "06/15/2023",
                status: "expired",
                images: [
                    {type: "front", url: "https://images.unsplash.com/photo-1556740738-b6a63e27c4df?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=870&q=80"},
                    {type: "overview", url: "https://images.unsplash.com/photo-1497366754035-f200968a6e72?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=870&q=80"},
                    {type: "map", url: "https://images.unsplash.com/photo-1549144511-f099e773c147?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=774&q=80"}
                ]
            }
        ];

        // Sample data for admin keys
        let adminKeys = [
            { key: "admin123", type: 1 },
            { key: "employee456", type: 2 }
        ];

        // Sample data for activity logs
        let activityLogs = [
            { action: "login", user: "admin123", timestamp: "2023-07-25 10:30:45" },
            { action: "edit_business", user: "admin123", business: "Sunset Diner", timestamp: "2023-07-25 10:32:18" },
            { action: "renew_business", user: "employee456", business: "Tech Solutions", timestamp: "2023-07-24 14:15:22" },
            { action: "add_business", user: "employee456", business: "Mountain View Lodge", timestamp: "2023-07-23 09:45:10" }
        ];

        // Current user state
        let currentUser = null;
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredBusinesses = [];
        let currentBusinessId = null;
        let currentImages = [];

        // DOM elements
        const searchBtn = document.getElementById('searchBtn');
        const searchSection = document.getElementById('searchSection');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const adminLoginModal = document.getElementById('adminLoginModal');
        const adminKeyInput = document.getElementById('adminKey');
        const cancelLoginBtn = document.getElementById('cancelLoginBtn');
        const submitLoginBtn = document.getElementById('submitLoginBtn');
        const businessTableBody = document.getElementById('businessTableBody');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageInfo = document.getElementById('pageInfo');
        const totalBusinesses = document.getElementById('totalBusinesses');
        const validCount = document.getElementById('validCount');
        const expiringCount = document.getElementById('expiringCount');
        const expiredCount = document.getElementById('expiredCount');
        const businessModal = document.getElementById('businessModal');
        const businessModalTitle = document.getElementById('businessModalTitle');
        const businessForm = document.getElementById('businessForm');
        const businessIdInput = document.getElementById('businessId');
        const businessNameInput = document.getElementById('businessName');
        const businessOwnerInput = document.getElementById('businessOwner');
        const businessTypeInput = document.getElementById('businessType');
        const businessLocationInput = document.getElementById('businessLocation');
        const applicationDateInput = document.getElementById('applicationDate');
        const renewalDateInput = document.getElementById('renewalDate');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const frontViewInput = document.getElementById('frontView');
        const overviewInput = document.getElementById('overview');
        const mapInput = document.getElementById('map');
        const cancelBusinessBtn = document.getElementById('cancelBusinessBtn');
        const submitBusinessBtn = document.getElementById('submitBusinessBtn');
        const viewBusinessModal = document.getElementById('viewBusinessModal');
        const viewBusinessName = document.getElementById('viewBusinessName');
        const viewOwner = document.getElementById('viewOwner');
        const viewType = document.getElementById('viewType');
        const viewLocation = document.getElementById('viewLocation');
        const viewAppDate = document.getElementById('viewAppDate');
        const viewRenewalDate = document.getElementById('viewRenewalDate');
        const viewStatus = document.getElementById('viewStatus');
        const adminActions = document.getElementById('adminActions');
        const editBusinessBtn = document.getElementById('editBusinessBtn');
        const renewBusinessBtn = document.getElementById('renewBusinessBtn');
        const deleteBusinessBtn = document.getElementById('deleteBusinessBtn');
        const businessCarousel = document.getElementById('businessCarousel');
        const carouselNav = document.getElementById('carouselNav');
        const adminPanelModal = document.getElementById('adminPanelModal');
        const adminKeysTableBody = document.getElementById('adminKeysTableBody');
        const newKeyInput = document.getElementById('newKeyInput');
        const newKeyType = document.getElementById('newKeyType');
        const addKeyBtn = document.getElementById('addKeyBtn');
        const activityLogsList = document.getElementById('activityLogs');
        const confirmModal = document.getElementById('confirmModal');
        const confirmTitle = document.getElementById('confirmTitle');
        const confirmMessage = document.getElementById('confirmMessage');
        const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
        const confirmActionBtn = document.getElementById('confirmActionBtn');
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const typeFilter = document.getElementById('typeFilter');
        const locationFilter = document.getElementById('locationFilter');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');

        // Close modals when clicking the X button
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });

        // Close modals when clicking outside the modal content
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        });

        // Toggle search section
        searchBtn.addEventListener('click', function() {
            searchSection.classList.toggle('hidden');
        });

        // Open admin login modal
        adminLoginBtn.addEventListener('click', function() {
            adminLoginModal.style.display = 'block';
            adminKeyInput.focus();
        });

        // Cancel admin login
        cancelLoginBtn.addEventListener('click', function() {
            adminLoginModal.style.display = 'none';
            adminKeyInput.value = '';
        });

        // Submit admin login
        submitLoginBtn.addEventListener('click', function() {
            const key = adminKeyInput.value.trim();
            if (key === '') return;
            
            const validKey = adminKeys.find(k => k.key === key);
            if (validKey) {
                currentUser = {
                    key: validKey.key,
                    type: validKey.type
                };
                
                // Update UI based on user type
                if (validKey.type === 1) {
                    adminLoginBtn.innerHTML = '<i class="fas fa-user-shield mr-2"></i>Admin Panel';
                } else {
                    adminLoginBtn.innerHTML = '<i class="fas fa-user-tie mr-2"></i>Employee Panel';
                }
                
                // Add activity log
                addActivityLog('login', key);
                
                adminLoginModal.style.display = 'none';
                adminKeyInput.value = '';
                
                // Refresh business list to show admin actions
                renderBusinessTable();
            } else {
                alert('Invalid admin key!');
            }
        });

        // Open admin panel (Key 1 only)
        adminLoginBtn.addEventListener('click', function() {
            if (currentUser && currentUser.type === 1) {
                adminPanelModal.style.display = 'block';
                renderAdminKeys();
                renderActivityLogs();
            }
        });

        // Add new admin key
        addKeyBtn.addEventListener('click', function() {
            const key = newKeyInput.value.trim();
            const type = parseInt(newKeyType.value);
            
            if (key === '') {
                alert('Please enter a key');
                return;
            }
            
            if (adminKeys.some(k => k.key === key)) {
                alert('This key already exists');
                return;
            }
            
            adminKeys.push({ key, type });
            newKeyInput.value = '';
            
            // Add activity log
            addActivityLog('add_key', currentUser.key, null, `Added ${type === 1 ? 'Admin' : 'Employee'} key`);
            
            renderAdminKeys();
        });

        // Delete admin key
        function deleteAdminKey(key) {
            openConfirmModal(
                'Delete Admin Key',
                'Are you sure you want to delete this admin key? This action cannot be undone.',
                function() {
                    adminKeys = adminKeys.filter(k => k.key !== key);
                    
                    // Add activity log
                    addActivityLog('delete_key', currentUser.key, null, `Deleted key: ${key}`);
                    
                    renderAdminKeys();
                    confirmModal.style.display = 'none';
                }
            );
        }

        // Render admin keys table
        function renderAdminKeys() {
            adminKeysTableBody.innerHTML = '';
            
            adminKeys.forEach(key => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 hover:bg-gray-700';
                
                const keyCell = document.createElement('td');
                keyCell.className = 'px-4 py-3';
                keyCell.textContent = key.key;
                
                const typeCell = document.createElement('td');
                typeCell.className = 'px-4 py-3';
                typeCell.textContent = key.type === 1 ? 'Key 1 (Owner)' : 'Key 2 (Employee)';
                
                const actionsCell = document.createElement('td');
                actionsCell.className = 'px-4 py-3 flex space-x-2';
                
                if (key.key !== currentUser.key) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg text-sm';
                    deleteBtn.innerHTML = '<i class="fas fa-trash-alt mr-1"></i> Delete';
                    deleteBtn.addEventListener('click', () => deleteAdminKey(key.key));
                    actionsCell.appendChild(deleteBtn);
                } else {
                    const currentLabel = document.createElement('span');
                    currentLabel.className = 'text-gray-400 text-sm';
                    currentLabel.textContent = 'Current';
                    actionsCell.appendChild(currentLabel);
                }
                
                row.appendChild(keyCell);
                row.appendChild(typeCell);
                row.appendChild(actionsCell);
                adminKeysTableBody.appendChild(row);
            });
        }

        // Render activity logs
        function renderActivityLogs() {
            activityLogsList.innerHTML = '';
            
            activityLogs.slice().reverse().forEach(log => {
                const li = document.createElement('li');
                li.className = 'border-b border-gray-700 pb-2';
                
                let actionText = '';
                switch(log.action) {
                    case 'login':
                        actionText = `${log.user} logged in`;
                        break;
                    case 'add_business':
                        actionText = `${log.user} added business: ${log.business}`;
                        break;
                    case 'edit_business':
                        actionText = `${log.user} edited business: ${log.business}`;
                        break;
                    case 'renew_business':
                        actionText = `${log.user} renewed business: ${log.business}`;
                        break;
                    case 'delete_business':
                        actionText = `${log.user} deleted business: ${log.business}`;
                        break;
                    case 'add_key':
                        actionText = log.message || `${log.user} added a new key`;
                        break;
                    case 'delete_key':
                        actionText = log.message || `${log.user} deleted a key`;
                        break;
                    default:
                        actionText = `${log.user} performed action: ${log.action}`;
                }
                
                li.innerHTML = `
                    <div class="flex justify-between">
                        <span>${actionText}</span>
                        <span class="text-gray-400 text-sm">${log.timestamp}</span>
                    </div>
                `;
                activityLogsList.appendChild(li);
            });
        }

        // Add activity log
        function addActivityLog(action, user, business = null, message = null) {
            const now = new Date();
            const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
            
            activityLogs.push({
                action,
                user,
                business,
                message,
                timestamp
            });
            
            if (adminPanelModal.style.display === 'block') {
                renderActivityLogs();
            }
        }

        // Open confirm modal
        function openConfirmModal(title, message, confirmCallback) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmModal.style.display = 'block';
            
            // Remove previous event listeners
            const newConfirmBtn = confirmActionBtn.cloneNode(true);
            confirmActionBtn.parentNode.replaceChild(newConfirmBtn, confirmActionBtn);
            
            newConfirmBtn.addEventListener('click', confirmCallback);
        }

        // Cancel confirm action
        cancelConfirmBtn.addEventListener('click', function() {
            confirmModal.style.display = 'none';
        });

        // Apply filters
        applyFiltersBtn.addEventListener('click', function() {
            currentPage = 1;
            filterBusinesses();
            renderBusinessTable();
        });

        // Filter businesses based on search and filters
        function filterBusinesses() {
            const searchTerm = searchInput.value.toLowerCase();
            const status = statusFilter.value;
            const type = typeFilter.value;
            const location = locationFilter.value;
            
            filteredBusinesses = businesses.filter(business => {
                // Search term
                const matchesSearch = searchTerm === '' || 
                    business.name.toLowerCase().includes(searchTerm) || 
                    business.owner.toLowerCase().includes(searchTerm);
                
                // Status filter
                const matchesStatus = status === 'all' || business.status === status;
                
                // Type filter
                const matchesType = type === 'all' || business.type === type;
                
                // Location filter
                const matchesLocation = location === 'all' || business.location === location;
                
                return matchesSearch && matchesStatus && matchesType && matchesLocation;
            });
            
            updateCounts();
        }

        // Update business counts
        function updateCounts() {
            const total = businesses.length;
            const valid = businesses.filter(b => b.status === 'valid').length;
            const expiring = businesses.filter(b => b.status === 'near-expiry').length;
            const expired = businesses.filter(b => b.status === 'expired').length;
            
            totalBusinesses.textContent = `Total: ${total}`;
            validCount.textContent = `Valid: ${valid}`;
            expiringCount.textContent = `Expiring: ${expiring}`;
            expiredCount.textContent = `Expired: ${expired}`;
        }

        // Render business table
        function renderBusinessTable() {
            businessTableBody.innerHTML = '';
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedBusinesses = filteredBusinesses.slice(startIndex, endIndex);
            
            if (paginatedBusinesses.length === 0) {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700';
                const cell = document.createElement('td');
                cell.colSpan = 7;
                cell.className = 'px-4 py-6 text-center text-gray-400';
                cell.textContent = 'No businesses found';
                row.appendChild(cell);
                businessTableBody.appendChild(row);
            } else {
                paginatedBusinesses.forEach(business => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700 hover:bg-gray-700';
                    
                    // Business Name
                    const nameCell = document.createElement('td');
                    nameCell.className = 'px-4 py-3';
                    nameCell.textContent = business.name;
                    
                    // Owner (clickable)
                    const ownerCell = document.createElement('td');
                    ownerCell.className = 'px-4 py-3';
                    const ownerLink = document.createElement('a');
                    ownerLink.href = '#';
                    ownerLink.className = 'text-blue-400 hover:text-blue-300';
                    ownerLink.textContent = business.owner;
                    ownerLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        viewBusinessesByOwner(business.owner);
                    });
                    ownerCell.appendChild(ownerLink);
                    
                    // Type
                    const typeCell = document.createElement('td');
                    typeCell.className = 'px-4 py-3';
                    typeCell.textContent = formatBusinessType(business.type);
                    
                    // Location
                    const locationCell = document.createElement('td');
                    locationCell.className = 'px-4 py-3';
                    locationCell.textContent = formatLocation(business.location);
                    
                    // Status
                    const statusCell = document.createElement('td');
                    statusCell.className = 'px-4 py-3';
                    const statusBadge = document.createElement('span');
                    statusBadge.className = 'status-badge';
                    
                    switch(business.status) {
                        case 'valid':
                            statusBadge.className += ' bg-green-600';
                            statusBadge.textContent = 'Valid';
                            break;
                        case 'near-expiry':
                            statusBadge.className += ' bg-yellow-600';
                            statusBadge.textContent = 'Near Expiry';
                            break;
                        case 'expired':
                            statusBadge.className += ' bg-red-600';
                            statusBadge.textContent = 'Expired';
                            break;
                    }
                    
                    statusCell.appendChild(statusBadge);
                    
                    // Last Renewal
                    const renewalCell = document.createElement('td');
                    renewalCell.className = 'px-4 py-3';
                    renewalCell.textContent = business.renewalDate;
                    
                    // Actions
                    const actionsCell = document.createElement('td');
                    actionsCell.className = 'px-4 py-3 flex space-x-2';
                    
                    // View button
                    const viewBtn = document.createElement('button');
                    viewBtn.className = 'bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded-lg text-sm';
                    viewBtn.innerHTML = '<i class="fas fa-eye mr-1"></i> View';
                    viewBtn.addEventListener('click', () => viewBusiness(business.id));
                    actionsCell.appendChild(viewBtn);
                    
                    // Admin actions
                    if (currentUser) {
                        // Edit button
                        const editBtn = document.createElement('button');
                        editBtn.className = 'bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded-lg text-sm';
                        editBtn.innerHTML = '<i class="fas fa-edit mr-1"></i> Edit';
                        editBtn.addEventListener('click', () => editBusiness(business.id));
                        actionsCell.appendChild(editBtn);
                        
                        // Renew button
                        const renewBtn = document.createElement('button');
                        renewBtn.className = 'bg-yellow-600 hover:bg-yellow-700 px-3 py-1 rounded-lg text-sm';
                        renewBtn.innerHTML = '<i class="fas fa-sync-alt mr-1"></i> Renew';
                        renewBtn.addEventListener('click', () => renewBusiness(business.id));
                        actionsCell.appendChild(renewBtn);
                        
                        // Delete button
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg text-sm';
                        deleteBtn.innerHTML = '<i class="fas fa-trash-alt mr-1"></i> Delete';
                        deleteBtn.addEventListener('click', () => deleteBusiness(business.id));
                        actionsCell.appendChild(deleteBtn);
                    }
                    
                    row.appendChild(nameCell);
                    row.appendChild(ownerCell);
                    row.appendChild(typeCell);
                    row.appendChild(locationCell);
                    row.appendChild(statusCell);
                    row.appendChild(renewalCell);
                    row.appendChild(actionsCell);
                    businessTableBody.appendChild(row);
                });
            }
            
            // Update pagination info
            const totalPages = Math.ceil(filteredBusinesses.length / itemsPerPage);
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            
            // Enable/disable pagination buttons
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
        }

        // Format business type for display
        function formatBusinessType(type) {
            const typeMap = {
                'restaurant': 'Restaurant',
                'store': 'Store',
                'mechanic': 'Mechanic',
                'clothing': 'Clothing',
                'bank': 'Bank',
                'club': 'Club/Entertainment',
                'security': 'Security',
                'tech': 'Tech/Repair',
                'health': 'Health/Clinic',
                'transportation': 'Transportation',
                'government': 'Government Office',
                'real-estate': 'Real Estate',
                'law': 'Law Office',
                'media': 'Media/News',
                'warehouse': 'Warehouse',
                'freelance': 'Freelance/Custom'
            };
            
            return typeMap[type] || type;
        }

        // Format location for display
        function formatLocation(location) {
            const locationMap = {
                'city1': 'City 1',
                'city2': 'City 2',
                'mountain': 'Mountain',
                'desert': 'Desert',
                'province': 'Province'
            };
            
            return locationMap[location] || location;
        }

        // View businesses by owner
        function viewBusinessesByOwner(owner) {
            filteredBusinesses = businesses.filter(b => b.owner === owner);
            currentPage = 1;
            renderBusinessTable();
            
            // Update search input to show the filter
            searchInput.value = owner;
            statusFilter.value = 'all';
            typeFilter.value = 'all';
            locationFilter.value = 'all';
        }

        // View business details
        function viewBusiness(id) {
            const business = businesses.find(b => b.id === id);
            if (!business) return;
            
            viewBusinessName.textContent = business.name;
            viewOwner.textContent = business.owner;
            viewType.textContent = formatBusinessType(business.type);
            viewLocation.textContent = formatLocation(business.location);
            viewAppDate.textContent = business.applicationDate;
            viewRenewalDate.textContent = business.renewalDate;
            
            // Status with tooltip
            let statusText = '';
            let statusClass = '';
            
            switch(business.status) {
                case 'valid':
                    statusText = 'ð¢ Valid';
                    statusClass = 'text-green-400';
                    break;
                case 'near-expiry':
                    statusText = 'ð¡ Near Expiry';
                    statusClass = 'text-yellow-400';
                    break;
                case 'expired':
                    statusText = 'ð´ Expired';
                    statusClass = 'text-red-400';
                    break;
            }
            
            viewStatus.innerHTML = `<span class="${statusClass}">${statusText}</span>`;
            
            // Show admin actions if user is admin
            if (currentUser) {
                adminActions.classList.remove('hidden');
            } else {
                adminActions.classList.add('hidden');
            }
            
            // Set current business ID
            currentBusinessId = id;
            
            // Render images carousel
            renderBusinessCarousel(business.images);
            
            viewBusinessModal.style.display = 'block';
        }

        // Render business images carousel
        function renderBusinessCarousel(images) {
            businessCarousel.innerHTML = '';
            carouselNav.innerHTML = '';
            
            if (images.length === 0) {
                const noImages = document.createElement('div');
                noImages.className = 'text-center py-8 text-gray-400';
                noImages.textContent = 'No images available';
                businessCarousel.appendChild(noImages);
                return;
            }
            
            images.forEach((image, index) => {
                const slide = document.createElement('div');
                slide.className = `slide ${index === 0 ? 'active' : ''}`;
                
                const img = document.createElement('img');
                img.src = image.url;
                img.alt = `${image.type} view`;
                img.className = 'carousel-image';
                
                const caption = document.createElement('div');
                caption.className = 'mt-2 text-center text-gray-300 capitalize';
                caption.textContent = `${image.type} view`;
                
                slide.appendChild(img);
                slide.appendChild(caption);
                businessCarousel.appendChild(slide);
                
                // Navigation dot
                const dot = document.createElement('span');
                dot.className = `carousel-dot ${index === 0 ? 'active' : ''}`;
                dot.dataset.index = index;
                dot.addEventListener('click', () => showSlide(index));
                carouselNav.appendChild(dot);
            });
        }

        // Show specific slide in carousel
        function showSlide(index) {
            const slides = document.querySelectorAll('.slide');
            const dots = document.querySelectorAll('.carousel-dot');
            
            slides.forEach(slide => slide.classList.remove('active'));
            dots.forEach(dot => dot.classList.remove('active'));
            
            slides[index].classList.add('active');
            dots[index].classList.add('active');
        }

        // Edit business
        function editBusiness(id) {
            const business = businesses.find(b => b.id === id);
            if (!business) return;
            
            businessModalTitle.textContent = 'Edit Business';
            businessIdInput.value = business.id;
            businessNameInput.value = business.name;
            businessOwnerInput.value = business.owner;
            businessTypeInput.value = business.type;
            businessLocationInput.value = business.location;
            
            // Format dates for input fields
            const [appMonth, appDay, appYear] = business.applicationDate.split('/');
            applicationDateInput.value = `${appYear}-${appMonth.padStart(2, '0')}-${appDay.padStart(2, '0')}`;
            
            const [renewMonth, renewDay, renewYear] = business.renewalDate.split('/');
            renewalDateInput.value = `${renewYear}-${renewMonth.padStart(2, '0')}-${renewDay.padStart(2, '0')}`;
            
            // Set current images
            currentImages = [...business.images];
            renderImagePreviews();
            
            viewBusinessModal.style.display = 'none';
            businessModal.style.display = 'block';
        }

        // Add new business
        function addNewBusiness() {
            businessModalTitle.textContent = 'Add New Business';
            businessForm.reset();
            businessIdInput.value = '';
            
            // Set default dates to today
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            applicationDateInput.value = todayStr;
            renewalDateInput.value = todayStr;
            
            // Clear images
            currentImages = [];
            renderImagePreviews();
            
            businessModal.style.display = 'block';
        }

        // Renew business
        function renewBusiness(id) {
            const business = businesses.find(b => b.id === id);
            if (!business) return;
            
            openConfirmModal(
                'Renew Business Permit',
                `Are you sure you want to renew the permit for ${business.name}?`,
                function() {
                    // Calculate new renewal date (1 month from now)
                    const today = new Date();
                    const newRenewalDate = new Date(today);
                    newRenewalDate.setMonth(today.getMonth() + 1);
                    
                    // Format as MM/DD/YYYY
                    const month = String(newRenewalDate.getMonth() + 1).padStart(2, '0');
                    const day = String(newRenewalDate.getDate()).padStart(2, '0');
                    const year = newRenewalDate.getFullYear();
                    const formattedDate = `${month}/${day}/${year}`;
                    
                    // Update business
                    business.renewalDate = formattedDate;
                    business.status = 'valid';
                    
                    // Add activity log
                    addActivityLog('renew_business', currentUser.key, business.name);
                    
                    // Refresh UI
                    renderBusinessTable();
                    confirmModal.style.display = 'none';
                    viewBusinessModal.style.display = 'none';
                }
            );
        }

        // Delete business
        function deleteBusiness(id) {
            const business = businesses.find(b => b.id === id);
            if (!business) return;
            
            openConfirmModal(
                'Delete Business',
                `Are you sure you want to delete ${business.name}? This action cannot be undone.`,
                function() {
                    businesses = businesses.filter(b => b.id !== id);
                    
                    // Add activity log
                    addActivityLog('delete_business', currentUser.key, business.name);
                    
                    // Refresh UI
                    filterBusinesses();
                    renderBusinessTable();
                    confirmModal.style.display = 'none';
                    viewBusinessModal.style.display = 'none';
                }
            );
        }

        // Handle image uploads
        frontViewInput.addEventListener('change', function(e) {
            handleImageUpload(e, 'front');
        });
        
        overviewInput.addEventListener('change', function(e) {
            handleImageUpload(e, 'overview');
        });
        
        mapInput.addEventListener('change', function(e) {
            handleImageUpload(e, 'map');
        });

        // Process image upload
        function handleImageUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                // Remove existing image of this type
                currentImages = currentImages.filter(img => img.type !== type);
                
                // Add new image
                currentImages.push({
                    type,
                    url: e.target.result
                });
                
                renderImagePreviews();
            };
            reader.readAsDataURL(file);
        }

        // Render image previews
        function renderImagePreviews() {
            imagePreviewContainer.innerHTML = '';
            
            currentImages.forEach(image => {
                const preview = document.createElement('div');
                preview.className = 'image-preview';
                preview.style.backgroundImage = `url(${image.url})`;
                
                // Add delete button for admins
                if (currentUser) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'absolute top-1 right-1 bg-red-600 hover:bg-red-700 rounded-full w-6 h-6 flex items-center justify-center';
                    deleteBtn.innerHTML = '<i class="fas fa-times text-xs"></i>';
                    deleteBtn.addEventListener('click', () => {
                        currentImages = currentImages.filter(img => img.url !== image.url);
                        renderImagePreviews();
                    });
                    preview.appendChild(deleteBtn);
                }
                
                const caption = document.createElement('div');
                caption.className = 'absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-center text-sm py-1 capitalize';
                caption.textContent = `${image.type} view`;
                preview.appendChild(caption);
                
                imagePreviewContainer.appendChild(preview);
            });
        }

        // Submit business form
        businessForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = businessIdInput.value;
            const name = businessNameInput.value.trim();
            const owner = businessOwnerInput.value.trim();
            const type = businessTypeInput.value;
            const location = businessLocationInput.value;
            const appDate = applicationDateInput.value;
            const renewalDate = renewalDateInput.value;
            
            if (!name || !owner || !type || !location || !appDate || !renewalDate) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Format dates as MM/DD/YYYY
            const formatDate = (dateStr) => {
                const [year, month, day] = dateStr.split('-');
                return `${month}/${day}/${year}`;
            };
            
            const formattedAppDate = formatDate(appDate);
            const formattedRenewalDate = formatDate(renewalDate);
            
            // Determine status based on renewal date
            const today = new Date();
            const renewalDateObj = new Date(renewalDate);
            const diffTime = renewalDateObj - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let status = 'valid';
            if (diffDays <= 0) {
                status = 'expired';
            } else if (diffDays <= 7) {
                status = 'near-expiry';
            }
            
            if (id) {
                // Update existing business
                const business = businesses.find(b => b.id === parseInt(id));
                if (business) {
                    business.name = name;
                    business.owner = owner;
                    business.type = type;
                    business.location = location;
                    business.applicationDate = formattedAppDate;
                    business.renewalDate = formattedRenewalDate;
                    business.status = status;
                    business.images = [...currentImages];
                    
                    // Add activity log
                    addActivityLog('edit_business', currentUser.key, business.name);
                }
            } else {
                // Add new business
                const newId = businesses.length > 0 ? Math.max(...businesses.map(b => b.id)) + 1 : 1;
                const newBusiness = {
                    id: newId,
                    name,
                    owner,
                    type,
                    location,
                    applicationDate: formattedAppDate,
                    renewalDate: formattedRenewalDate,
                    status,
                    images: [...currentImages]
                };
                
                businesses.push(newBusiness);
                
                // Add activity log
                addActivityLog('add_business', currentUser.key, newBusiness.name);
            }
            
            // Refresh UI
            filterBusinesses();
            renderBusinessTable();
            businessModal.style.display = 'none';
        });

        // Cancel business form
        cancelBusinessBtn.addEventListener('click', function() {
            businessModal.style.display = 'none';
        });

        // Edit business from view modal
        editBusinessBtn.addEventListener('click', function() {
            if (currentBusinessId) {
                viewBusinessModal.style.display = 'none';
                editBusiness(currentBusinessId);
            }
        });

        // Pagination controls
        prevPageBtn.addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                renderBusinessTable();
            }
        });
        
        nextPageBtn.addEventListener('click', function() {
            const totalPages = Math.ceil(filteredBusinesses.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderBusinessTable();
            }
        });

        // Initialize
        function init() {
            // Set default filtered businesses
            filteredBusinesses = [...businesses];
            updateCounts();
            
            // Render initial business table
            renderBusinessTable();
            
            // Set today's date as default for new businesses
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            applicationDateInput.value = todayStr;
            renewalDateInput.value = todayStr;
            
            // Set up event listeners for admin buttons if logged in
            if (currentUser) {
                if (currentUser.type === 1) {
                    adminLoginBtn.innerHTML = '<i class="fas fa-user-shield mr-2"></i>Admin Panel';
                } else {
                    adminLoginBtn.innerHTML = '<i class="fas fa-user-tie mr-2"></i>Employee Panel';
                }
            }
        }

        // Run initialization
        init();
    </script>
</body>
</html>
